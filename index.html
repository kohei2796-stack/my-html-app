<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>山高グラフ作成</title>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<style>
/* ===== Theme Variables ===== */
:root {
  --bg: #ffffff;
  --surface: #f7f8fa;
  --surface2: #eef0f4;
  --border: #dce0e8;
  --text: #333333;
  --text2: #777777;
  --heading: #222222;
  --accent: #6673b0;
  --accent2: #8e7aad;
  --white: #222222;
  --seg-text: #444;
  --seg-shadow: none;
  --bar-shadow: 0 1px 4px rgba(0,0,0,0.08);
  --modal-overlay: rgba(0,0,0,0.3);
}
body.dark {
  --bg: #1a1e2e;
  --surface: #232840;
  --surface2: #2a3050;
  --border: #353b55;
  --text: #c8cdd8;
  --text2: #8a90a5;
  --heading: #e0e4ee;
  --accent: #6c7bbd;
  --accent2: #9b6bbf;
  --white: #e8ecf4;
  --seg-text: #fff;
  --seg-shadow: 0 1px 3px rgba(0,0,0,0.5);
  --bar-shadow: 0 2px 8px rgba(0,0,0,0.3);
  --modal-overlay: rgba(0,0,0,0.6);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', 'Meiryo', sans-serif; background: var(--bg); color: var(--text); padding: 20px; min-height: 100vh; transition: background 0.3s, color 0.3s; }

/* Theme toggle */
.theme-toggle { position: fixed; top: 14px; right: 20px; z-index: 100; display: flex; align-items: center; gap: 6px; }
.theme-toggle span { font-size: 0.75rem; color: var(--text2); }
.toggle-track { width: 44px; height: 24px; background: var(--border); border-radius: 12px; cursor: pointer; position: relative; transition: background 0.3s; }
body.dark .toggle-track { background: var(--accent); }
.toggle-knob { width: 20px; height: 20px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
body.dark .toggle-knob { transform: translateX(20px); }

/* Title */
.title-area { text-align: center; margin-bottom: 20px; }
.title-input { background: transparent; border: 1px solid transparent; color: var(--heading); font-size: 1.5rem; font-weight: 700; text-align: center; padding: 4px 12px; border-radius: 6px; width: auto; min-width: 200px; max-width: 90vw; font-family: inherit; }
.title-input:hover { border-color: var(--border); }
.title-input:focus { outline: none; border-color: var(--accent); background: var(--surface); }

/* Legend */
.legend { display: flex; justify-content: center; gap: 20px; margin-bottom: 16px; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: var(--text2); }
.legend-color { width: 16px; height: 12px; border-radius: 2px; border: 1px solid var(--border); }

/* Category Management */
.category-section { background: var(--surface); border-radius: 10px; padding: 16px; margin-bottom: 20px; border: 1px solid var(--border); }
.category-section h2 { font-size: 0.95rem; color: var(--text2); margin-bottom: 10px; }
.category-list { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
.category-chip { display: flex; align-items: center; gap: 6px; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; color: var(--text); border: 1px solid var(--border); background: var(--surface2); }
.category-chip input[type="text"] { background: transparent; border: none; color: var(--heading); font-size: 0.8rem; width: 60px; text-align: center; font-family: inherit; outline: none; }
.category-chip input[type="color"] { width: 18px; height: 18px; border: none; border-radius: 50%; cursor: pointer; padding: 0; background: transparent; }
.category-chip input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
.category-chip input[type="color"]::-webkit-color-swatch { border: 1px solid var(--border); border-radius: 50%; }
.category-chip .del-cat { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 0.85rem; padding: 0 2px; line-height: 1; }
.category-chip .del-cat:hover { color: #d35; }
.add-cat-btn { padding: 5px 14px; border-radius: 20px; border: 1px dashed var(--border); background: transparent; color: var(--text2); font-size: 0.8rem; cursor: pointer; font-family: inherit; }
.add-cat-btn:hover { border-color: var(--accent); color: var(--accent); }

/* Chart Area */
.chart-container { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 30px 20px 20px; margin-bottom: 20px; overflow-x: auto; }
.chart-wrapper { position: relative; }
.chart-area { display: flex; align-items: flex-end; justify-content: center; min-height: 360px; gap: 0; padding: 0 20px; position: relative; padding-top: 44px; }

/* Edge diff */
.edge-diff { position: absolute; top: 0; left: 0; right: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
.edge-diff-label { background: var(--accent2); color: #fff; font-size: 0.75rem; font-weight: 700; padding: 3px 12px; border-radius: 12px; white-space: nowrap; }

/* Bar */
.bar-wrapper { display: flex; flex-direction: column; align-items: center; min-width: 80px; flex-shrink: 0; }
.bar-total { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; color: var(--heading); }
.bar-stack { display: flex; flex-direction: column-reverse; width: 60px; border-radius: 4px 4px 0 0; overflow: hidden; box-shadow: var(--bar-shadow); }
.bar-segment { display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: var(--seg-text); font-weight: 600; text-shadow: var(--seg-shadow); transition: height 0.3s ease; min-height: 0; overflow: hidden; }
.bar-label { margin-top: 8px; }
.bar-label input { width: 80px; text-align: center; border: 1px solid transparent; background: transparent; font-size: 0.78rem; color: var(--text2); border-radius: 4px; padding: 2px; font-family: inherit; }
.bar-label input:hover { border-color: var(--border); }
.bar-label input:focus { border-color: var(--accent); background: var(--surface2); outline: none; color: var(--heading); }

/* Between zone */
.between-zone { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding: 0 6px; align-self: stretch; flex-shrink: 0; }
.diff-badge { background: var(--accent2); color: #fff; font-size: 0.72rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-bottom: 4px; white-space: nowrap; }
.diff-arrow { font-size: 0.65rem; color: var(--accent2); margin-bottom: 2px; }
.comment-list { display: flex; flex-direction: column; align-items: center; gap: 6px; margin-bottom: 6px; }
.comment-item { display: flex; flex-direction: column; align-items: center; }
.comment-bracket { display: flex; align-items: stretch; gap: 0; }
.bracket-left, .bracket-right { width: 5px; border: 1.5px solid var(--text2); min-height: 20px; }
.bracket-left { border-right: none; border-radius: 3px 0 0 3px; }
.bracket-right { border-left: none; border-radius: 0 3px 3px 0; }
.comment-text { font-size: 0.72rem; color: var(--text); text-align: center; padding: 3px 6px; cursor: pointer; border: 1px solid transparent; border-radius: 3px; white-space: pre-wrap; line-height: 1.4; word-break: break-all; }
.comment-text:hover { border-color: var(--border); background: var(--surface2); }
.comment-actions button { font-size: 0.6rem; padding: 0 4px; border: 1px solid var(--border); background: var(--surface); border-radius: 3px; cursor: pointer; color: var(--text2); line-height: 1.4; }
.comment-actions button:hover { border-color: #d35; color: #d35; }
.add-comment-btn { font-size: 0.68rem; color: var(--text2); cursor: pointer; border: 1px dashed var(--border); background: transparent; border-radius: 4px; padding: 2px 8px; white-space: nowrap; margin-bottom: 8px; font-family: inherit; }
.add-comment-btn:hover { border-color: var(--accent); color: var(--accent); }

/* Modal */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--modal-overlay); z-index: 1000; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; min-width: 340px; max-width: 90vw; box-shadow: 0 12px 40px rgba(0,0,0,0.25); }
.modal-box h3 { margin-bottom: 12px; font-size: 1rem; color: var(--heading); }
.modal-box textarea { width: 100%; min-height: 120px; border: 1px solid var(--border); border-radius: 6px; padding: 10px; font-size: 0.9rem; font-family: inherit; resize: vertical; background: var(--surface2); color: var(--text); }
.modal-box textarea:focus { outline: none; border-color: var(--accent); }
.modal-hint { font-size: 0.7rem; color: var(--text2); margin-top: 4px; }
.modal-buttons { display: flex; gap: 8px; margin-top: 14px; justify-content: flex-end; }
.modal-buttons button { padding: 7px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; font-family: inherit; }
.modal-btn-ok { background: var(--accent); color: #fff; }
.modal-btn-ok:hover { filter: brightness(1.1); }
.modal-btn-cancel { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); }
.modal-btn-cancel:hover { filter: brightness(0.95); }

/* Input Table */
.input-section { background: var(--surface); border-radius: 12px; border: 1px solid var(--border); padding: 20px; }
.input-section h2 { font-size: 1rem; margin-bottom: 12px; color: var(--text2); }
.toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.toolbar button { padding: 7px 18px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.82rem; font-weight: 600; transition: filter 0.2s; font-family: inherit; }
.btn-add { background: var(--accent); color: #fff; }
.btn-add:hover { filter: brightness(1.1); }
.btn-export { background: var(--accent2); color: #fff; }
.btn-export:hover { filter: brightness(1.1); }

table { width: 100%; border-collapse: collapse; }
th, td { padding: 8px 8px; text-align: center; border-bottom: 1px solid var(--border); font-size: 0.82rem; }
th { background: var(--surface2); color: var(--text2); font-weight: 600; }
td input[type="number"] { width: 80px; padding: 5px 6px; border: 1px solid var(--border); border-radius: 5px; text-align: right; font-size: 0.82rem; background: var(--surface2); color: var(--text); font-family: inherit; }
td input[type="number"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(102,115,176,0.2); }
td.bar-name-cell input { width: 90px; padding: 5px 6px; border: 1px solid var(--border); border-radius: 5px; text-align: center; font-size: 0.82rem; background: var(--surface2); color: var(--text); font-family: inherit; }
td .delete-bar-btn { background: none; border: none; color: var(--text2); cursor: pointer; font-size: 1rem; padding: 2px 6px; border-radius: 4px; }
td .delete-bar-btn:hover { color: #d35; }
</style>
</head>
<body>

<!-- Theme Toggle -->
<div class="theme-toggle">
  <span>White</span>
  <div class="toggle-track" id="themeToggle" onclick="toggleTheme()">
    <div class="toggle-knob"></div>
  </div>
  <span>Dark</span>
</div>

<div class="title-area">
  <input type="text" class="title-input" id="chartTitle" value="山高グラフ（積み上げ棒グラフ）" oninput="this.style.width=(this.value.length+2)+'ch'">
</div>

<div id="legendArea" class="legend"></div>

<div class="category-section">
  <h2>費目設定</h2>
  <div class="category-list" id="categoryList"></div>
</div>

<div class="chart-container">
  <div class="chart-wrapper">
    <div id="edgeDiff" class="edge-diff"></div>
    <div class="chart-area" id="chartArea"></div>
  </div>
</div>

<div class="input-section">
  <h2>データ入力</h2>
  <div class="toolbar">
    <button class="btn-add" onclick="addBar()">＋ 棒を追加</button>
    <button class="btn-export" onclick="exportPPTX()">PPT出力</button>
  </div>
  <div style="overflow-x:auto">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="inputBody"></tbody>
    </table>
  </div>
</div>

<!-- Comment Modal -->
<div class="modal-overlay" id="commentModal">
  <div class="modal-box">
    <h3 id="modalTitle">コメント入力</h3>
    <textarea id="modalTextarea" placeholder="コメントを入力（改行可）"></textarea>
    <div class="modal-hint">Ctrl+Enter で確定 / Esc でキャンセル</div>
    <div class="modal-buttons">
      <button class="modal-btn-cancel" onclick="closeModal()">キャンセル</button>
      <button class="modal-btn-ok" onclick="submitModal()">OK</button>
    </div>
  </div>
</div>

<script>
// ==================== Theme ====================
function toggleTheme() {
  document.body.classList.toggle('dark');
}

// ==================== Data ====================
// Pastel / muted colors for bar segments
let categories = [
  { id: 'c1', name: 'D費', color: '#a8c4e0' },
  { id: 'c2', name: 'R費', color: '#a3d1b5' },
  { id: 'c3', name: '間接費', color: '#e0cfa3' },
  { id: 'c4', name: '海外', color: '#d4a9a9' },
];
let nextCatId = 5;

let bars = [
  { id: 1, name: '項目1', values: { c1: 0, c2: 0, c3: 0, c4: 0 } },
  { id: 2, name: '項目2', values: { c1: 0, c2: 0, c3: 0, c4: 0 } },
  { id: 3, name: '項目3', values: { c1: 0, c2: 0, c3: 0, c4: 0 } },
];
let nextBarId = 4;

let comments = [];
let nextCommentId = 1;

const MAX_CHART_HEIGHT = 320;

// ==================== Helpers ====================
function getTotal(bar) {
  let s = 0;
  categories.forEach(c => { s += (bar.values[c.id] || 0); });
  return s;
}
function getMaxTotal() {
  let m = 0;
  bars.forEach(b => { const t = getTotal(b); if (t > m) m = t; });
  return m || 1;
}

// ==================== Modal ====================
let modalCallback = null;
function openModal(title, defaultText, callback) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalTextarea').value = defaultText || '';
  modalCallback = callback;
  document.getElementById('commentModal').classList.add('active');
  setTimeout(() => document.getElementById('modalTextarea').focus(), 50);
}
function closeModal() {
  document.getElementById('commentModal').classList.remove('active');
  modalCallback = null;
}
function submitModal() {
  const text = document.getElementById('modalTextarea').value;
  if (modalCallback) modalCallback(text);
  closeModal();
}
document.getElementById('modalTextarea').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); submitModal(); }
  if (e.key === 'Escape') { closeModal(); }
});

// ==================== Category Management ====================
function renderCategories() {
  const list = document.getElementById('categoryList');
  list.innerHTML = '';
  categories.forEach(cat => {
    const chip = document.createElement('div');
    chip.className = 'category-chip';

    const colorInput = document.createElement('input');
    colorInput.type = 'color';
    colorInput.value = cat.color;
    colorInput.oninput = function() { cat.color = this.value; render(); };
    chip.appendChild(colorInput);

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = cat.name;
    nameInput.style.width = Math.max(40, cat.name.length * 14 + 10) + 'px';
    nameInput.oninput = function() {
      cat.name = this.value;
      this.style.width = Math.max(40, this.value.length * 14 + 10) + 'px';
      render();
    };
    chip.appendChild(nameInput);

    if (categories.length > 1) {
      const del = document.createElement('button');
      del.className = 'del-cat';
      del.textContent = '\u2715';
      del.onclick = () => removeCategory(cat.id);
      chip.appendChild(del);
    }
    list.appendChild(chip);
  });

  const addBtn = document.createElement('button');
  addBtn.className = 'add-cat-btn';
  addBtn.textContent = '＋ 費目追加';
  addBtn.onclick = addCategory;
  list.appendChild(addBtn);
}

function addCategory() {
  const id = 'c' + nextCatId++;
  const palette = ['#b5c7d8','#b8d4c0','#d8ccb0','#ccb5b5','#b0b5d8','#c0b8d4','#b5d8cc','#d4c0b8'];
  const color = palette[categories.length % palette.length];
  categories.push({ id, name: '新規', color });
  bars.forEach(b => { b.values[id] = 0; });
  render();
}

function removeCategory(catId) {
  if (categories.length <= 1) return;
  categories = categories.filter(c => c.id !== catId);
  bars.forEach(b => { delete b.values[catId]; });
  render();
}

// ==================== Legend ====================
function renderLegend() {
  const area = document.getElementById('legendArea');
  area.innerHTML = '';
  categories.forEach(cat => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    const swatch = document.createElement('div');
    swatch.className = 'legend-color';
    swatch.style.background = cat.color;
    item.appendChild(swatch);
    item.appendChild(document.createTextNode(cat.name));
    area.appendChild(item);
  });
}

// ==================== Render ====================
function render() {
  renderCategories();
  renderLegend();
  renderChart();
  renderTable();
  renderEdgeDiff();
}

function renderEdgeDiff() {
  const el = document.getElementById('edgeDiff');
  el.innerHTML = '';
  if (bars.length < 2) return;
  const firstTotal = getTotal(bars[0]);
  const lastTotal = getTotal(bars[bars.length - 1]);
  const diff = lastTotal - firstTotal;
  if (firstTotal === 0 && lastTotal === 0) return;
  const sign = diff > 0 ? '+' : '';
  const arrow = diff > 0 ? '\u25B2 ' : diff < 0 ? '\u25BC ' : '';
  el.innerHTML = '<div style="width:85%;display:flex;align-items:center;">' +
    '<div style="flex:1;height:1.5px;background:var(--accent2);"></div>' +
    '<div class="edge-diff-label">' + arrow + sign + diff.toLocaleString() + '\uFF08' + bars[0].name + ' \u2192 ' + bars[bars.length-1].name + '\uFF09</div>' +
    '<div style="flex:1;height:1.5px;background:var(--accent2);"></div>' +
    '</div>';
}

function renderChart() {
  const area = document.getElementById('chartArea');
  area.innerHTML = '';
  const maxVal = getMaxTotal();
  const scale = MAX_CHART_HEIGHT / maxVal;

  bars.forEach((bar, idx) => {
    if (idx > 0) {
      const prevBar = bars[idx - 1];
      area.appendChild(buildBetweenZone(prevBar, bar, prevBar.id));
    }

    const group = document.createElement('div');
    group.className = 'bar-wrapper';

    const total = getTotal(bar);
    const totalEl = document.createElement('div');
    totalEl.className = 'bar-total';
    totalEl.textContent = total > 0 ? total.toLocaleString() : '';
    group.appendChild(totalEl);

    const stack = document.createElement('div');
    stack.className = 'bar-stack';
    categories.forEach(cat => {
      const val = bar.values[cat.id] || 0;
      const seg = document.createElement('div');
      seg.className = 'bar-segment';
      seg.style.background = cat.color;
      const h = val * scale;
      seg.style.height = h + 'px';
      if (h >= 18) seg.textContent = val.toLocaleString();
      stack.appendChild(seg);
    });
    group.appendChild(stack);

    const labelDiv = document.createElement('div');
    labelDiv.className = 'bar-label';
    const labelInput = document.createElement('input');
    labelInput.type = 'text';
    labelInput.value = bar.name;
    labelInput.oninput = function() { bar.name = this.value; syncTableName(bar.id, this.value); renderEdgeDiff(); };
    labelDiv.appendChild(labelInput);
    group.appendChild(labelDiv);

    area.appendChild(group);
  });
}

function buildBetweenZone(prevBar, nextBar, afterBarId) {
  const zone = document.createElement('div');
  zone.className = 'between-zone';

  // Compute needed width from comments
  const relevantComments = comments.filter(c => c.afterBarId === afterBarId);
  let maxLen = 0;
  relevantComments.forEach(c => {
    const lines = (c.text || '').split('\n');
    lines.forEach(l => { if (l.length > maxLen) maxLen = l.length; });
  });
  const autoWidth = Math.max(70, Math.min(280, maxLen * 9 + 40));
  zone.style.minWidth = autoWidth + 'px';

  // Auto diff
  const prevTotal = getTotal(prevBar);
  const nextTotal = getTotal(nextBar);
  const diff = nextTotal - prevTotal;
  if (prevTotal > 0 || nextTotal > 0) {
    const arrow = document.createElement('div');
    arrow.className = 'diff-arrow';
    arrow.textContent = diff > 0 ? '\u25B2' : diff < 0 ? '\u25BC' : '\u25B6';
    zone.appendChild(arrow);
    const badge = document.createElement('div');
    badge.className = 'diff-badge';
    badge.textContent = (diff > 0 ? '+' : '') + diff.toLocaleString();
    zone.appendChild(badge);
  }

  // Comments
  if (relevantComments.length > 0) {
    const list = document.createElement('div');
    list.className = 'comment-list';
    relevantComments.forEach(c => {
      const item = document.createElement('div');
      item.className = 'comment-item';

      const row = document.createElement('div');
      row.className = 'comment-bracket';
      const bl = document.createElement('div');
      bl.className = 'bracket-left';
      const txt = document.createElement('div');
      txt.className = 'comment-text';
      txt.textContent = c.text || '(クリックで編集)';
      txt.onclick = () => editComment(c.id);
      const br2 = document.createElement('div');
      br2.className = 'bracket-right';
      row.appendChild(bl);
      row.appendChild(txt);
      row.appendChild(br2);
      item.appendChild(row);

      const actions = document.createElement('div');
      actions.className = 'comment-actions';
      const delBtn = document.createElement('button');
      delBtn.textContent = '\u2715';
      delBtn.onclick = () => deleteComment(c.id);
      actions.appendChild(delBtn);
      item.appendChild(actions);

      list.appendChild(item);
    });
    zone.appendChild(list);
  }

  const addBtn = document.createElement('button');
  addBtn.className = 'add-comment-btn';
  addBtn.textContent = '+ コメント';
  addBtn.onclick = () => addComment(afterBarId);
  zone.appendChild(addBtn);

  return zone;
}

// ==================== Comments ====================
function addComment(afterBarId) {
  openModal('コメント入力', '', (text) => {
    if (text === '') return;
    comments.push({ id: nextCommentId++, afterBarId, text });
    render();
  });
}
function editComment(commentId) {
  const c = comments.find(x => x.id === commentId);
  if (!c) return;
  openModal('コメント編集', c.text, (text) => { c.text = text; render(); });
}
function deleteComment(commentId) {
  comments = comments.filter(c => c.id !== commentId);
  render();
}

// ==================== Table ====================
function renderTable() {
  const head = document.getElementById('tableHead');
  head.innerHTML = '';
  const htr = document.createElement('tr');
  ['', '名称'].forEach(t => {
    const th = document.createElement('th');
    th.textContent = t;
    htr.appendChild(th);
  });
  categories.forEach(cat => {
    const th = document.createElement('th');
    th.textContent = cat.name;
    th.style.borderBottom = '2px solid ' + cat.color;
    htr.appendChild(th);
  });
  const thTotal = document.createElement('th');
  thTotal.textContent = '合計';
  htr.appendChild(thTotal);
  head.appendChild(htr);

  const body = document.getElementById('inputBody');
  body.innerHTML = '';
  bars.forEach(bar => {
    const tr = document.createElement('tr');

    const tdDel = document.createElement('td');
    if (bars.length > 1) {
      const btn = document.createElement('button');
      btn.className = 'delete-bar-btn';
      btn.textContent = '\u2715';
      btn.onclick = () => removeBar(bar.id);
      tdDel.appendChild(btn);
    }
    tr.appendChild(tdDel);

    const tdName = document.createElement('td');
    tdName.className = 'bar-name-cell';
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.value = bar.name;
    nameInput.id = 'name-' + bar.id;
    nameInput.oninput = function() { bar.name = this.value; renderChart(); renderEdgeDiff(); };
    tdName.appendChild(nameInput);
    tr.appendChild(tdName);

    categories.forEach(cat => {
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.value = bar.values[cat.id] || '';
      input.placeholder = '0';
      input.oninput = function() {
        bar.values[cat.id] = parseFloat(this.value) || 0;
        renderChart();
        renderEdgeDiff();
        updateTotalCell(bar.id);
      };
      td.appendChild(input);
      tr.appendChild(td);
    });

    const tdTotal = document.createElement('td');
    tdTotal.id = 'total-' + bar.id;
    tdTotal.style.fontWeight = '700';
    tdTotal.style.color = 'var(--heading)';
    tdTotal.textContent = getTotal(bar).toLocaleString();
    tr.appendChild(tdTotal);

    body.appendChild(tr);
  });
}

function updateTotalCell(barId) {
  const bar = bars.find(b => b.id === barId);
  if (!bar) return;
  const el = document.getElementById('total-' + barId);
  if (el) el.textContent = getTotal(bar).toLocaleString();
}

function syncTableName(barId, name) {
  const el = document.getElementById('name-' + barId);
  if (el && el.value !== name) el.value = name;
}

function addBar() {
  const values = {};
  categories.forEach(c => { values[c.id] = 0; });
  bars.push({ id: nextBarId, name: '項目' + nextBarId, values });
  nextBarId++;
  render();
}

function removeBar(barId) {
  if (bars.length <= 1) return;
  comments = comments.filter(c => c.afterBarId !== barId);
  bars = bars.filter(b => b.id !== barId);
  render();
}

// ==================== PPT Export ====================
function exportPPTX() {
  const pptx = new PptxGenJS();
  const slide = pptx.addSlide();
  slide.background = { color: 'FFFFFF' };

  const title = document.getElementById('chartTitle').value;
  slide.addText(title, {
    x: 0.3, y: 0.15, w: 9.4, h: 0.5,
    fontSize: 18, bold: true, color: '2c3e50', fontFace: 'Meiryo'
  });

  // Legend
  categories.forEach((cat, i) => {
    const lx = 0.5 + i * 1.4;
    const hexColor = cat.color.replace('#', '');
    slide.addShape(pptx.shapes.RECTANGLE, { x: lx, y: 0.65, w: 0.22, h: 0.16, fill: { color: hexColor } });
    slide.addText(cat.name, { x: lx + 0.28, y: 0.6, w: 1, h: 0.28, fontSize: 8, color: '555555', fontFace: 'Meiryo' });
  });

  const maxVal = getMaxTotal();
  if (maxVal === 0) { pptx.writeFile({ fileName: '山高グラフ.pptx' }); return; }

  const chartTop = 1.1;
  const chartHeight = 4.0;
  const barWidth = 0.85;
  const gapWidth = 1.0;
  const totalWidth = bars.length * barWidth + (bars.length - 1) * gapWidth;
  const startX = Math.max(0.5, (10 - totalWidth) / 2);
  const baseY = chartTop + chartHeight;
  const scale = chartHeight / maxVal;

  bars.forEach((bar, idx) => {
    const bx = startX + idx * (barWidth + gapWidth);
    let currentY = baseY;

    categories.forEach(cat => {
      const val = bar.values[cat.id] || 0;
      if (val <= 0) return;
      const h = val * scale;
      currentY -= h;
      const hexColor = cat.color.replace('#', '');
      slide.addShape(pptx.shapes.RECTANGLE, {
        x: bx, y: currentY, w: barWidth, h: h,
        fill: { color: hexColor },
      });
      if (h >= 0.2) {
        slide.addText(val.toLocaleString(), {
          x: bx, y: currentY, w: barWidth, h: h,
          fontSize: 8, color: '444444', bold: true, align: 'center', valign: 'middle', fontFace: 'Meiryo'
        });
      }
    });

    const total = getTotal(bar);
    if (total > 0) {
      const topY = baseY - total * scale;
      slide.addText(total.toLocaleString(), {
        x: bx - 0.15, y: topY - 0.28, w: barWidth + 0.3, h: 0.28,
        fontSize: 10, bold: true, color: '2c3e50', align: 'center', fontFace: 'Meiryo'
      });
    }

    slide.addText(bar.name, {
      x: bx - 0.15, y: baseY + 0.05, w: barWidth + 0.3, h: 0.28,
      fontSize: 9, color: '555555', align: 'center', fontFace: 'Meiryo'
    });

    if (idx > 0) {
      const prevBar = bars[idx - 1];
      const prevTotal = getTotal(prevBar);
      const diff = total - prevTotal;
      const sign = diff > 0 ? '+' : '';
      const arrow = diff > 0 ? '\u25B2 ' : diff < 0 ? '\u25BC ' : '';
      const midX = bx - gapWidth / 2 - 0.35;
      slide.addText(arrow + sign + diff.toLocaleString(), {
        x: midX, y: chartTop + chartHeight * 0.38, w: 0.7, h: 0.3,
        fontSize: 8, bold: true, color: '7b5e9b', align: 'center', fontFace: 'Meiryo',
        fill: { color: 'F0EBF5' }, shape: pptx.shapes.ROUNDED_RECTANGLE, rectRadius: 0.08
      });

      const relevantComments = comments.filter(c => c.afterBarId === prevBar.id);
      relevantComments.forEach((c, ci) => {
        slide.addText(c.text, {
          x: midX - 0.15, y: chartTop + chartHeight * 0.52 + ci * 0.4, w: 1.0, h: 0.35,
          fontSize: 7, color: '555555', align: 'center', fontFace: 'Meiryo', valign: 'top'
        });
      });
    }
  });

  // Edge diff
  if (bars.length >= 2) {
    const firstTotal = getTotal(bars[0]);
    const lastTotal = getTotal(bars[bars.length - 1]);
    const diff = lastTotal - firstTotal;
    const sign = diff > 0 ? '+' : '';
    const arrow = diff > 0 ? '\u25B2 ' : diff < 0 ? '\u25BC ' : '';
    const lineY = chartTop - 0.12;
    const x1 = startX + barWidth / 2;
    const x2 = startX + (bars.length - 1) * (barWidth + gapWidth) + barWidth / 2;

    slide.addShape(pptx.shapes.LINE, {
      x: x1, y: lineY, w: x2 - x1, h: 0,
      line: { color: '7b5e9b', width: 1.5 }
    });
    slide.addText(arrow + sign + diff.toLocaleString() + '\uFF08' + bars[0].name + ' \u2192 ' + bars[bars.length - 1].name + '\uFF09', {
      x: (x1 + x2) / 2 - 1.2, y: lineY - 0.28, w: 2.4, h: 0.24,
      fontSize: 8, bold: true, color: '7b5e9b', align: 'center', fontFace: 'Meiryo',
      fill: { color: 'F0EBF5' }, shape: pptx.shapes.ROUNDED_RECTANGLE, rectRadius: 0.06
    });
  }

  pptx.writeFile({ fileName: '山高グラフ.pptx' });
}

// ==================== Init ====================
render();
const ti = document.getElementById('chartTitle');
ti.style.width = (ti.value.length + 2) + 'ch';
</script>
</body>
</html>
